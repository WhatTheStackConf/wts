version: "3.8"

services:
  webapp:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      pocketbase:
        condition: service_healthy
    environment:
      - POCKETBASE_URL=http://pocketbase:8090
      - PUBLIC_POCKETBASE_URL=${PUBLIC_POCKETBASE_URL:-http://localhost:8090}
    restart: unless-stopped

  pocketbase:
    build:
      context: ./pocketbase
      dockerfile: Dockerfile
    environment:
      - PB_SUPERUSER_EMAIL=${POCKETBASE_SUPERUSER_EMAIL}
      - PB_SUPERUSER_PASSWORD=${POCKETBASE_SUPERUSER_PASSWORD}
    volumes:
      # Persistent storage for PocketBase data
      - pocketbase_data:/pb/pb_data
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8090/api/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  pocketbase_data:
    # This ensures data persistence between deployments

networks:
  default:
    name: wts_network
